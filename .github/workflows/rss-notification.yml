name: RSS ì•Œë¦¼ ìŠ¤ì¼€ì¤„ëŸ¬

# ìŠ¤ì¼€ì¤„ë§ ì„¤ì •
on:
  schedule:
    # KST 09:00 = UTC 00:00
    - cron: '0 0 * * *'
    # KST 12:00 = UTC 03:00
    - cron: '0 3 * * *'
    # KST 15:00 = UTC 06:00
    - cron: '0 6 * * *'
    # KST 18:00 = UTC 09:00
    - cron: '0 9 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: false
        default: 'once'
        type: choice
        options:
          - 'once'
          - 'schedule'
      test_run:
        description: 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì—¬ë¶€'
        required: false
        default: false
        type: boolean

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  TZ: Asia/Seoul
  NODE_ENV: production
  LOG_LEVEL: info

jobs:
  rss-notification:
    runs-on: ubuntu-latest
    
    # íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ë¶„)
    timeout-minutes: 30
    
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      # pnpm ì„¤ì¹˜ (í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €)
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0
      
      # Node.js í™˜ê²½ ì„¤ì •
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      # ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • (ìºì‹œ í‚¤ìš©)
      - name: ë‚ ì§œ ì„¤ì •
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
      
      # RSS ìºì‹œ ë³µì›
      - name: RSS ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: .cache/rss-daily-cache.json
          key: rss-daily-cache-${{ steps.date.outputs.date }}
          restore-keys: |
            rss-daily-cache-
      
      # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (Secretsê³¼ Variables ëª¨ë‘ ì‚¬ìš©)
      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN || vars.TELEGRAM_BOT_TOKEN }}" >> .env
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID || vars.TELEGRAM_CHAT_ID }}" >> .env
          echo "WEBHOOK_SECRET=${{ secrets.WEBHOOK_SECRET || vars.WEBHOOK_SECRET }}" >> .env
          echo "NODE_ENV=production" >> .env
          echo "LOG_LEVEL=info" >> .env
          echo "TZ=Asia/Seoul" >> .env
          echo "PORT=3000" >> .env
          echo "RSS_SCHEDULE_CRON=30 8 * * *" >> .env
      
      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì„ íƒì )
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        if: ${{ github.event.inputs.test_run == 'true' }}
        run: |
          echo "ğŸ§ª í•„í„°ë§ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
          node src/test/aiFilterTest.js || true
          node src/test/lenientFilterTest.js || true
      
      # RSS ì•Œë¦¼ ì‹¤í–‰
      - name: RSS ì•Œë¦¼ ì‹¤í–‰
        run: |
          # ìŠ¤ì¼€ì¤„ íŠ¸ë¦¬ê±° ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ê°ì§€
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "â° ìŠ¤ì¼€ì¤„ ì‹¤í–‰: KST 9ì‹œ/12ì‹œ/15ì‹œ/18ì‹œ"
            node index.js --once --filter-days=1
          elif [ "${{ github.event.inputs.mode }}" == "schedule" ]; then
            echo "ğŸ“… ìˆ˜ë™ ìŠ¤ì¼€ì¤„ ëª¨ë“œë¡œ ì‹¤í–‰"
            node index.js
          else
            echo "ğŸš€ í•œë²ˆ ì‹¤í–‰ ëª¨ë“œ"
            node index.js --once --filter-days=1
          fi
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN || vars.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID || vars.TELEGRAM_CHAT_ID }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET || vars.WEBHOOK_SECRET }}
      
      # ì‹¤í–‰ ì™„ë£Œ ë¡œê·¸
      - name: ì‹¤í–‰ ì™„ë£Œ ì•Œë¦¼
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… RSS ì•Œë¦¼ ì‹¤í–‰ ì™„ë£Œ"
          else
            echo "âŒ RSS ì•Œë¦¼ ì‹¤í–‰ ì‹¤íŒ¨"
          fi