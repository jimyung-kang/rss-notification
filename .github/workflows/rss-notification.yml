name: RSS ì•Œë¦¼ ìŠ¤ì¼€ì¤„ëŸ¬

# ìŠ¤ì¼€ì¤„ë§ ì„¤ì •
on:
  schedule:
    # KST 09:00 = UTC 00:00
    # - cron: '0 0 * * *'
    # KST 12:00 = UTC 03:00
    # - cron: '0 3 * * *'
    # KST 15:00 = UTC 06:00
    # - cron: '0 6 * * *'
    # KST 18:00 = UTC 09:00
    # - cron: '0 9 * * *'
    - cron: '*/10 * * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  workflow_dispatch:
    inputs:
      mode:
        description: 'ì‹¤í–‰ ëª¨ë“œ'
        required: false
        default: 'once'
        type: choice
        options:
          - 'once'

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  TZ: Asia/Seoul
  NODE_ENV: production
  LOG_LEVEL: debug  # ë””ë²„ê·¸ ë¡œê·¸ í™œì„±í™”

jobs:
  rss-notification:
    runs-on: ubuntu-latest
    
    # Environment ì„¤ì •
    environment: production
    
    # íƒ€ì„ì•„ì›ƒ ì„¤ì • (30ë¶„)
    timeout-minutes: 30
    
    steps:
      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      # pnpm ì„¤ì¹˜ (í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €)
      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0
      
      # Node.js í™˜ê²½ ì„¤ì •
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      # ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì • (ìºì‹œ í‚¤ìš©)
      - name: ë‚ ì§œ ì„¤ì •
        id: date
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      # ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile
      
      # RSS ìºì‹œ ë³µì›
      - name: RSS ìºì‹œ ë³µì›
        id: cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: rss-daily-cache-${{ steps.date.outputs.date }}-${{ hashFiles('**/package.json') }}
          restore-keys: |
            rss-daily-cache-${{ steps.date.outputs.date }}-
            rss-daily-cache-
      
      # ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„± (ìºì‹œê°€ ì—†ëŠ” ê²½ìš°)
      - name: ìºì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          mkdir -p .cache
          echo '{}' > .cache/rss-daily-cache.json
          echo "ğŸ“‚ ìºì‹œ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ìƒì„± ì™„ë£Œ"
      
      # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (Secretsê³¼ Variables ëª¨ë‘ ì‚¬ìš©)
      - name: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN || vars.TELEGRAM_BOT_TOKEN }}" >> .env
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID || vars.TELEGRAM_CHAT_ID }}" >> .env
          echo "WEBHOOK_SECRET=${{ secrets.WEBHOOK_SECRET || vars.WEBHOOK_SECRET }}" >> .env
          echo "NODE_ENV=production" >> .env
          echo "LOG_LEVEL=info" >> .env
          echo "TZ=Asia/Seoul" >> .env
          echo "PORT=3000" >> .env
          echo "RSS_SCHEDULE_CRON=30 8 * * *" >> .env
          echo "CI=true" >> .env

      # í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        run: |
          echo "ğŸ“‹ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸:"
          echo "   - Environment: production"
          echo "   - NODE_ENV: $NODE_ENV"
          echo "   - LOG_LEVEL: $LOG_LEVEL"
          echo "   - TZ: $TZ"
          echo "   - TELEGRAM_BOT_TOKEN: $(if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then echo "âœ… secretsì—ì„œ ì„¤ì •ë¨"; elif [ -n "${{ vars.TELEGRAM_BOT_TOKEN }}" ]; then echo "âš ï¸ varsì—ì„œ ì„¤ì •ë¨"; else echo "âŒ ëˆ„ë½"; fi)"
          echo "   - TELEGRAM_CHAT_ID: $(if [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then echo "âœ… secretsì—ì„œ ì„¤ì •ë¨"; elif [ -n "${{ vars.TELEGRAM_CHAT_ID }}" ]; then echo "âš ï¸ varsì—ì„œ ì„¤ì •ë¨"; else echo "âŒ ëˆ„ë½"; fi)"
          echo "   - ì‹¤í–‰ ëª¨ë“œ: ${{ github.event_name }}"
          echo "   - ì‹¤í–‰ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S %Z')"

      # RSS ì•Œë¦¼ ì‹¤í–‰
      - name: RSS ì•Œë¦¼ ì‹¤í–‰
        run: |
          # CI í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (íŒŒì¼ ìºì‹œ ëª¨ë“œ ì‘ë™)
          export CI=true
          
          # ìŠ¤ì¼€ì¤„ íŠ¸ë¦¬ê±° ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ê°ì§€
          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "â° ìŠ¤ì¼€ì¤„ ì‹¤í–‰"
            echo "ğŸ“… í•„í„° ë‚ ì§œ: ìµœê·¼ 3ì¼"
            echo "ğŸ’¾ ìºì‹œ ëª¨ë“œ: íŒŒì¼ (CI=true)"
            # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œì—ëŠ” --once ì˜µì…˜ ì œê±°í•˜ì—¬ ìºì‹œê°€ ì •ìƒ ì‘ë™í•˜ë„ë¡ í•¨
            node index.js --filter-days=3
          else
            echo "ğŸš€ ìˆ˜ë™ ì‹¤í–‰ ëª¨ë“œ"
            echo "ğŸ“… í•„í„° ë‚ ì§œ: ìµœê·¼ 3ì¼"
            echo "ğŸ’¾ ìºì‹œ ëª¨ë“œ: íŒŒì¼ (CI=true)"
            # ìˆ˜ë™ ì‹¤í–‰ë„ ìºì‹œë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•¨
            node index.js --filter-days=3
          fi
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN || vars.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID || vars.TELEGRAM_CHAT_ID }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET || vars.WEBHOOK_SECRET }}
      
      # ìºì‹œ íŒŒì¼ ìƒíƒœ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: ìºì‹œ íŒŒì¼ ìƒíƒœ í™•ì¸
        if: always()
        run: |
          echo "ğŸ“‚ ìºì‹œ íŒŒì¼ í™•ì¸:"
          if [ -f .cache/rss-daily-cache.json ]; then
            echo "   - ìºì‹œ íŒŒì¼ ì¡´ì¬ âœ…"
            echo "   - íŒŒì¼ í¬ê¸°: $(du -h .cache/rss-daily-cache.json | cut -f1)"
            echo "   - ìºì‹œ ë‚´ìš© ì˜ˆì‹œ:"
            # JSON íŒŒì¼ì˜ ì²˜ìŒ ë¶€ë¶„ í™•ì¸
            head -n 20 .cache/rss-daily-cache.json | jq '.' 2>/dev/null || echo "     ë¹ˆ ìºì‹œ ë˜ëŠ” í˜•ì‹ ì˜¤ë¥˜"
            
            # ìºì‹œ í†µê³„
            echo "   - ìºì‹œ í†µê³„:"
            CACHE_SIZE=$(jq 'to_entries | map(.value | length) | add' .cache/rss-daily-cache.json 2>/dev/null || echo "0")
            echo "     ì´ ìºì‹œëœ í•­ëª©: ${CACHE_SIZE}ê°œ"
          else
            echo "   - ìºì‹œ íŒŒì¼ ì—†ìŒ âš ï¸"
            echo "   - ìƒˆë¡œìš´ ì‹¤í–‰ì´ê±°ë‚˜ ìºì‹œê°€ ì´ˆê¸°í™”ëœ ìƒíƒœ"
          fi
      
      # ìºì‹œ ì €ì¥ (ë‹¤ìŒ ì‹¤í–‰ì„ ìœ„í•´)
      - name: ìºì‹œ ì €ì¥
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .cache
          key: rss-daily-cache-${{ steps.date.outputs.date }}-${{ hashFiles('**/package.json') }}
      
      # ì‹¤í–‰ ì™„ë£Œ ë¡œê·¸
      - name: ì‹¤í–‰ ì™„ë£Œ ì•Œë¦¼
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… RSS ì•Œë¦¼ ì‹¤í–‰ ì™„ë£Œ"
            echo "ğŸ“Š ì‹¤í–‰ ìš”ì•½:"
            echo "   - ì‹¤í–‰ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S %Z')"
            echo "   - ì‹¤í–‰ ëª¨ë“œ: ${{ github.event_name }}"
            echo "   - ì‘ì—… ìƒíƒœ: ì„±ê³µ"
          else
            echo "âŒ RSS ì•Œë¦¼ ì‹¤í–‰ ì‹¤íŒ¨"
            echo "   - ì˜¤ë¥˜ ë°œìƒ ì‹œì ì„ í™•ì¸í•˜ì„¸ìš”"
          fi
