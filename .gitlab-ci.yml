# GitLab CI/CD for RSS ì•Œë¦¼ ìŠ¤ì¼€ì¤„ëŸ¬
# GitLab Runnerì—ì„œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” RSS ì•Œë¦¼ ì‹œìŠ¤í…œ

# ìŠ¤í…Œì´ì§€ ì •ì˜
stages:
  - setup
  - test
  - notify

# ê¸°ë³¸ ì´ë¯¸ì§€ ì„¤ì •
image: node:20-alpine

# ìºì‹œ ì„¤ì •
cache:
  paths:
    - node_modules/
    - .pnpm-store/
    - .cache/

# ì „ì—­ ë³€ìˆ˜ ì„¤ì •
variables:
  TZ: "Asia/Seoul"
  NODE_ENV: "production"
  LOG_LEVEL: "info"
  PNPM_CACHE_FOLDER: .pnpm-store
  npm_config_cache: .pnpm-store

# ê³µí†µ ì„¤ì • í…œí”Œë¦¿
.common_setup: &common_setup
  - echo "ğŸš€ GitLab CI/CD RSS ì•Œë¦¼ ì‹œìŠ¤í…œ ì‹œì‘"
  - apk update && apk add --no-cache tzdata
  - cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  - echo "Asia/Seoul" > /etc/timezone
  - corepack enable
  - corepack prepare pnpm@10.14.0 --activate
  - pnpm config set store-dir .pnpm-store

# Job í…œí”Œë¦¿ ì •ì˜
.job_template: &job_template
  timeout: 30m
  before_script:
    - *common_setup
    - pnpm install --frozen-lockfile
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ì˜ì¡´ì„± ì„¤ì¹˜ ë° ìºì‹œ ìƒì„±
setup:
  stage: setup
  <<: *job_template
  script:
    - echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ê²€ì¦"
    - pnpm install --frozen-lockfile
    - echo "âœ… ì„¤ì • ì™„ë£Œ"
  artifacts:
    paths:
      - node_modules/
      - .pnpm-store/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì„ íƒì )
test:
  stage: test
  <<: *job_template
  script:
    - echo "ğŸ§ª í•„í„°ë§ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸"
    - |
      if [ -f "src/test/aiFilterTest.js" ]; then
        node src/test/aiFilterTest.js || echo "âš ï¸ AI í•„í„° í…ŒìŠ¤íŠ¸ ê²½ê³  ë°œìƒ"
      fi
    - |
      if [ -f "src/test/lenientFilterTest.js" ]; then
        node src/test/lenientFilterTest.js || echo "âš ï¸ ê´€ëŒ€í•œ í•„í„° í…ŒìŠ¤íŠ¸ ê²½ê³  ë°œìƒ"
      fi
    - echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
  allow_failure: true
  only:
    variables:
      - $RUN_TESTS == "true"

# RSS ì•Œë¦¼ ì‹¤í–‰ - ìŠ¤ì¼€ì¤„ ê¸°ë°˜
rss-notification-scheduled:
  stage: notify
  <<: *job_template
  script:
    - echo "â° ìŠ¤ì¼€ì¤„ ê¸°ë°˜ RSS ì•Œë¦¼ ì‹¤í–‰"
    - |
      # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      cat > .env << EOF
      TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      WEBHOOK_SECRET=${WEBHOOK_SECRET}
      NODE_ENV=production
      LOG_LEVEL=info
      TZ=Asia/Seoul
      PORT=3000
      RSS_SCHEDULE_CRON=30 8 * * *
      EOF
    - echo "ğŸ“± RSS í”¼ë“œ í™•ì¸ ë° ì•Œë¦¼ ì „ì†¡"
    - node index.js --once --filter-days=1
    - echo "âœ… RSS ì•Œë¦¼ ì™„ë£Œ - $(date '+%Y-%m-%d %H:%M:%S KST')"
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ë§¤ì¼ KST 09:00, 12:00, 15:00, 18:00
  # GitLab ìŠ¤ì¼€ì¤„ì€ ì›¹ ì¸í„°í˜ì´ìŠ¤ì—ì„œ ì„¤ì •í•´ì•¼ í•¨
  only:
    - schedules
  environment:
    name: production

# RSS ì•Œë¦¼ ì‹¤í–‰ - ìˆ˜ë™ ì‹¤í–‰
rss-notification-manual:
  stage: notify
  <<: *job_template
  script:
    - echo "ğŸš€ ìˆ˜ë™ RSS ì•Œë¦¼ ì‹¤í–‰"
    - |
      # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      cat > .env << EOF
      TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      WEBHOOK_SECRET=${WEBHOOK_SECRET}
      NODE_ENV=production
      LOG_LEVEL=info
      TZ=Asia/Seoul
      PORT=3000
      RSS_SCHEDULE_CRON=30 8 * * *
      EOF
    - |
      # ì‹¤í–‰ ëª¨ë“œ ê²°ì •
      if [ "$EXECUTION_MODE" = "schedule" ]; then
        echo "ğŸ“… ìŠ¤ì¼€ì¤„ ëª¨ë“œë¡œ ì‹¤í–‰"
        node index.js
      elif [ "$EXECUTION_MODE" = "test" ]; then
        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰"
        node index.js --once --dry-run --filter-days=3
      else
        echo "ğŸ¯ í•œë²ˆ ì‹¤í–‰ ëª¨ë“œ (ê¸°ë³¸ê°’)"
        node index.js --once --filter-days=1
      fi
    - echo "âœ… RSS ì•Œë¦¼ ì™„ë£Œ - $(date '+%Y-%m-%d %H:%M:%S KST')"
  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš©
  when: manual
  only:
    - main
    - develop
  environment:
    name: production
  # ì»¤ìŠ¤í…€ ë³€ìˆ˜ ì§€ì›
  variables:
    EXECUTION_MODE: "once"  # once, schedule, test

# ê¸´ê¸‰ ì•Œë¦¼ ì‹¤í–‰ (ì¦‰ì‹œ ì‹¤í–‰)
rss-notification-urgent:
  stage: notify
  <<: *job_template
  script:
    - echo "ğŸš¨ ê¸´ê¸‰ RSS ì•Œë¦¼ ì‹¤í–‰"
    - |
      # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      cat > .env << EOF
      TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      WEBHOOK_SECRET=${WEBHOOK_SECRET}
      NODE_ENV=production
      LOG_LEVEL=info
      TZ=Asia/Seoul
      PORT=3000
      EOF
    - echo "âš¡ ê¸´ê¸‰ ëª¨ë“œ: ìµœê·¼ 3ì¼ê°„ ì—…ë°ì´íŠ¸ í™•ì¸"
    - node index.js --once --filter-days=3
    - echo "âœ… ê¸´ê¸‰ ì•Œë¦¼ ì™„ë£Œ - $(date '+%Y-%m-%d %H:%M:%S KST')"
  # ìˆ˜ë™ ì‹¤í–‰, ì–¸ì œë“  ê°€ëŠ¥
  when: manual
  allow_failure: false
  environment:
    name: production

# ì‹¤í–‰ í›„ ì •ë¦¬ ì‘ì—…
after_script:
  - echo "ğŸ§¹ ì •ë¦¬ ì‘ì—…"
  - |
    if [ -f ".env" ]; then
      rm -f .env
      echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"
    fi
  - |
    if [ -d "logs" ]; then
      echo "ğŸ“Š ë¡œê·¸ í†µê³„:"
      find logs -name "*.log" -type f -exec wc -l {} + 2>/dev/null || echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
    fi
  - echo "ğŸ‰ ì‘ì—… ì™„ë£Œ - $(date '+%Y-%m-%d %H:%M:%S KST')"